
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if the user is the owner by reading their role from Firestore.
    // This function is robust against non-existent user documents.
    function isOwner() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }
    
    // Project Files
    // Any authenticated user can upload and read project files.
    match /project_files/{projectId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Health & Safety Files
    // - Any authenticated user can read (download) files.
    // - Only the owner can write (upload, update, delete) files.
    match /health_and_safety_files/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if isOwner();
    }
  }
}
