
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check if the user is the 'owner'.
    // Must be a safe read: check existence before accessing data from Firestore.
    function isOwner() {
      let userId = request.auth.uid;
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.role == 'owner';
    }
    
    // Helper function to check if the user is an 'admin' or 'owner'.
    function isPrivilegedUser() {
        let userId = request.auth.uid;
        return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.role in ['admin', 'owner'];
    }

    // Health & Safety Files: Only owner can write, any authenticated user can read.
    match /health_and_safety_files/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if isOwner(); // write covers create, update, delete
    }

    // Project Files: Any authenticated user can upload. Only the uploader or a privileged user can delete.
    match /project_files/{projectId}/{fileId} {
      allow read: if request.auth != null;
      // Allow create/update for any logged in user
      allow create, update: if request.auth != null;
      // Allow uploader or privileged user to delete
      allow delete: if request.auth != null && (request.auth.uid == resource.metadata.uploaderId || isPrivilegedUser());
    }

    // Default deny all other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
