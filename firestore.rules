rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOwner() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }
    function isAdmin() {
      let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return userRole == 'admin' || userRole == 'owner';
    }
    function isSignedIn() {
      return request.auth != null;
    }

    // Users Collection
    match /users/{userId} {
      allow read; // All signed-in users can read profiles for name lookups
      allow create: if request.auth.uid == userId; // Allow users to create their own profile on signup
      allow update: if request.auth.uid == userId || isOwner(); // Users can update their own profile, owner can update any
    }
    
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth.uid == userId; // Users can only access their own subcollections
    }

    // Shifts Collection
    match /shifts/{shiftId} {
      allow read, update: if request.auth.uid == resource.data.userId; // Users can only read/update their own shifts
      allow create, delete: if isAdmin(); // Only admins/owners can create or delete shifts for anyone
    }

    // Projects Collection
    match /projects/{projectId} {
      allow read: if isSignedIn(); // All signed-in users can view project details
      allow create, update, delete: if isAdmin(); // Only admins/owners can manage projects

      // Files Subcollection
      match /files/{fileId} {
        allow read: if isSignedIn(); // All signed-in users can view files
        
        // Allow create/delete only for admins/owners OR the user who uploaded the file
        allow create: if isSignedIn();
        allow delete: if isAdmin() || request.auth.uid == resource.data.uploaderId;
      }
    }

    // Settings Collection
    match /settings/{docId} {
      allow read, write: if isOwner(); // Only owner can read/write global settings
    }
    
    // Announcements Collection
    match /announcements/{announcementId} {
      allow read: if isSignedIn(); // All signed-in users can read announcements.
      allow create, update: if isAdmin(); // Only admins/owners can create or update announcements.
      allow delete: if isAdmin(); // Admins/owners can delete announcements (deletion is now handled client-side with recursive=true in the rule)

      // Acknowledgements Subcollection
      match /acknowledgedBy/{userId} {
        // Correct Rule: A user can create a document here if their UID matches the document ID they are trying to create.
        allow create: if request.auth.uid == userId;
        allow read: if isAdmin(); // Only admins/owners can read the list of who has acknowledged.
      }
    }
  }
}
