rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin or owner
    function isOwnerOrAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];
    }

    // Helper function to check if a user is the owner of the app
    function isOwner() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }

    match /users/{userId} {
      // Allow user to read their own profile, or if the requester is an admin/owner
      allow read: if request.auth.uid == userId || isOwnerOrAdmin();
      // Allow user to create their own profile on signup
      allow create: if request.auth.uid == userId;
      // Allow user to update their own profile (except role)
      allow update: if request.auth.uid == userId && request.resource.data.role == resource.data.role;
      // Only owners can change roles
      allow update: if isOwner() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role']);
    }

    match /shifts/{shiftId} {
      // Admins/owners can do anything
      allow read, write: if isOwnerOrAdmin();
      
      // Users can read shifts assigned to them
      allow read: if request.auth.uid == resource.data.userId;

      // Users can update the status and notes of their own shifts
      allow update: if request.auth.uid == resource.data.userId
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'notes']);
    }

    match /projects/{projectId} {
        // Admins/owners can do anything with project documents
        allow write: if isOwnerOrAdmin();
        // Any authenticated user can read project details
        allow read: if request.auth != null;

        // Rules for the 'files' subcollection within a project
        match /files/{fileId} {
            // Admins/owners can do anything with file documents
            allow write: if isOwnerOrAdmin();
            // Any authenticated user can read file details
            allow read: if request.auth != null;
            // Any authenticated user can upload (create) a file record
            allow create: if request.auth != null;
            // The user who uploaded the file can delete it.
            // Admin/owner deletes are handled by a secure Cloud Function.
            allow delete: if request.auth.uid == resource.data.uploaderId;
        }
    }

    match /announcements/{announcementId} {
        // Admins/owners can create, update, delete
        allow write: if isOwnerOrAdmin();
        // Any authenticated user can read
        allow read: if request.auth != null;
    }
    
    // Push subscriptions are nested under the user
    match /users/{userId}/pushSubscriptions/{subscriptionId} {
      // Users can only manage their own subscriptions
      allow read, write, delete: if request.auth.uid == userId;
    }
  }
}
