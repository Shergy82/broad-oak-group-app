rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin or owner roles
    function isPrivileged() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];
    }

    // /users/{userId}
    match /users/{userId} {
      // Anyone can create a user account (sign up).
      allow create: if request.auth.uid == userId;
      // Only authenticated users can see the user list.
      allow list: if request.auth != null;
      // Users can read their own profile. Admins/owners can read anyone's profile.
      allow get: if request.auth.uid == userId || isPrivileged();
      // Users can update their own profile. Owners can update any user's profile.
      allow update: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
      // Only the owner can delete a user.
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }

    // /users/{userId}/pushSubscriptions/{subscriptionId}
    match /users/{userId}/pushSubscriptions/{subscriptionId} {
      // Users can manage their own push notification subscriptions.
      allow read, write, delete: if request.auth.uid == userId;
    }

    // /shifts/{shiftId}
    match /shifts/{shiftId} {
        // Any authenticated user can read their own shifts. Admins/owners can read all shifts.
        allow get: if request.auth.uid == resource.data.userId || isPrivileged();
        allow list: if isPrivileged(); // Only privileged users can query the whole collection.

        // Admins/owners can create, update, and delete shifts for anyone.
        // Regular users can update their own shifts (e.g., to change status).
        allow create: if isPrivileged();
        allow update: if isPrivileged() || request.auth.uid == resource.data.userId;
        allow delete: if isPrivileged();
    }
    
    // /projects/{projectId}
    match /projects/{projectId} {
        // Any authenticated user can view all projects.
        allow read: if request.auth != null;
        // Only admins/owners can create or delete projects.
        allow create, delete, update: if isPrivileged();
        
        // /projects/{projectId}/files/{fileId}
        match /files/{fileId} {
            // Any authenticated user can read files.
            allow read: if request.auth != null;
            // Any authenticated user can upload (create) a file record.
            allow create: if request.auth != null;
            // The user who uploaded the file, or an admin/owner, can delete it.
            allow delete: if request.auth.uid == resource.data.uploaderId || isPrivileged();
        }
    }
    
    // /announcements/{announcementId}
    match /announcements/{announcementId} {
        // Any authenticated user can read announcements.
        allow read: if request.auth != null;
        // Only admins/owners can create, update, or delete announcements.
        allow write: if isPrivileged();
    }

    // /settings/notifications
    match /settings/notifications {
      // Any authenticated user can read the master toggle state.
      allow read: if request.auth != null;
      
      // Only the user with the 'owner' role can change it.
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }
  }
}
