rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user has a specific role
    function isRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // Helper function to check if the user is an owner or admin
    function isOwnerOrAdmin() {
      return isRole('owner') || isRole('admin');
    }
    
    // USERS collection
    match /users/{userId} {
      // Anyone can create their own user document during sign-up
      allow create: if request.auth.uid == userId;
      
      // Users can read their own document, Admins/Owners can read any
      allow read: if request.auth.uid == userId || isOwnerOrAdmin();
      
      // Only the owner can update user documents (via Cloud Function) or their status.
      // Note: Direct updates are discouraged in favor of callable functions.
      allow update: if isRole('owner');

      // Deletion is handled by a callable function, restricted to owner.
      allow delete: if false;

      match /pushSubscriptions/{subscriptionId} {
        // Users can manage their own push subscriptions
        allow read, write, delete: if request.auth.uid == userId;
      }
    }
    
    // SHIFTS collection
    match /shifts/{shiftId} {
      // Admins and owners can create, read, update, and delete any shift
      allow read, delete, create: if isOwnerOrAdmin();

      // Users can update their own shifts (e.g., changing status).
      // They can also read shifts assigned to them.
      allow update: if isOwnerOrAdmin() || (
        request.resource.data.userId == request.auth.uid
      );
      
      // Granular read access is handled by queries in the app.
      // A general read rule is not secure here.
      // `allow read: if request.auth.uid == resource.data.userId;` could be used
      // but client-side queries are better for this app's structure.

    }

    // PROJECTS collection
    match /projects/{projectId} {
      // Admins/Owners can manage projects. All authenticated users can read them.
      allow read: if request.auth != null;
      allow create, update, delete: if isOwnerOrAdmin();

      // FILES subcollection
      match /files/{fileId} {
        // All authenticated users can read files.
        allow read: if request.auth != null;
        // Users can upload files. Deletion/updates are managed by role.
        allow create: if request.auth != null;
        allow update, delete: if isOwnerOrAdmin() || request.auth.uid == resource.data.uploaderId;
      }
    }
    
    // ANNOUNCEMENTS collection
    match /announcements/{announcementId} {
      // All authenticated users can read announcements
      allow read: if request.auth != null;
      // Only admins and owners can create, update, or delete them
      allow create, update, delete: if isOwnerOrAdmin();
      
      match /acknowledgedBy/{userId} {
        // Users can only acknowledge for themselves
        allow create: if request.auth.uid == userId;
        // Only the user or an admin/owner can read an acknowledgement
        allow read: if request.auth.uid == userId || isOwnerOrAdmin();
        allow update, delete: if false; // Prevent modification/deletion
      }
    }

    // SETTINGS collection
    match /settings/{docId} {
        // Only owner can read/write global settings
        allow read, write: if isRole('owner');
    }
  }
}
