rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user has a specific role
    function isRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // USERS collection
    match /users/{userId} {
      // Anyone can create their own user profile (on signup)
      allow create: if request.auth.uid == userId;
      // Users can only read their own profile, admins and owners can read any profile
      allow read: if request.auth.uid == userId || isRole('admin') || isRole('owner');
      // Users can update their own profile, but cannot change their role.
      // Owners can update any user's profile.
      allow update: if (request.auth.uid == userId && request.resource.data.role == resource.data.role) || isRole('owner');
    }

    // USERS/SUBSCRIPTIONS subcollection
    match /users/{userId}/pushSubscriptions/{subscriptionId} {
      // A user can manage their own push notification subscriptions
      allow read, write, delete: if request.auth.uid == userId;
    }

    // SHIFTS collection
    match /shifts/{shiftId} {
      // Admins and Owners can read all shifts
      allow read: if isRole('admin') || isRole('owner');
       // Only allow users to read shifts assigned to them
      allow read: if resource.data.userId == request.auth.uid;
      // Admins and Owners can create, update, and delete any shift
      allow write: if isRole('admin') || isRole('owner');
      // Users can update their own shifts (e.g., to change status), but not create/delete them
      allow update: if resource.data.userId == request.auth.uid;
    }
    
    // ANNOUNCEMENTS collection
    match /announcements/{announcementId} {
      // Any authenticated user can read announcements
      allow read: if request.auth != null;
      // Only admins and owners can create, update, or delete announcements
      allow write: if isRole('admin') || isRole('owner');
    }

    // PROJECTS and subcollections
    match /projects/{projectId} {
      // Any authenticated user can read project details
      allow read: if request.auth != null;
      // Admins and owners can create and delete projects
      allow create, delete: if isRole('admin') || isRole('owner');

      match /files/{fileId} {
        // Any authenticated user can read file details
        allow read: if request.auth != null;
        // Any authenticated user can upload files (create file documents)
        allow create: if request.auth != null;
        // Users can delete their own files. Admins/owners can delete any file.
        allow delete: if resource.data.uploaderId == request.auth.uid || isRole('admin') || isRole('owner');
      }
    }
    
    // SETTINGS collection
    match /settings/notifications {
      // Any authenticated user can READ the notification setting
      allow read: if request.auth != null;
      // Only the OWNER can WRITE (toggle) the notification setting
      allow write: if isRole('owner');
    }
  }
}
